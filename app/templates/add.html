{% extends "base.html" %}
{% block title %}Quick Add · NoteKeep{% endblock %}
{% block content %}
<!-- Back button -->
<div class="m-3">
  <a href="/links"
    class="inline-flex items-center gap-2 text-gray-600 hover:text-primary-600 transition-colors text-sm">
    <i data-lucide="arrow-left" class="w-4 h-4"></i>
    Back to Links
  </a>
</div>

<!-- <div class="mb-4 sm:mb-6">
  <h1 class="text-lg sm:text-2xl font-semibold text-gray-900 mb-1">Quick Add</h1>
</div> -->

<!-- Tab Navigation -->
<div class="border-b border-gray-200 mb-4 sm:mb-6">
  <nav class="flex gap-4 sm:gap-8">
    <button onclick="switchAddTab('single')" data-add-tab="single"
      class="add-tab-button py-2 sm:py-3 px-1 border-b-2 border-indigo-600 text-indigo-600 font-medium text-xs sm:text-sm">
      Single Link
    </button>
    <button onclick="switchAddTab('bulk')" data-add-tab="bulk"
      class="add-tab-button py-2 sm:py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-xs sm:text-sm">
      Bulk Import
    </button>
    <button onclick="switchAddTab('note')" data-add-tab="note"
      class="add-tab-button py-2 sm:py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-xs sm:text-sm">
      <i data-lucide="file-text" class="w-4 h-4 inline-block mr-1"></i>
      Personal Note
    </button>
  </nav>
</div>

<!-- Single Link Tab -->
<div id="single-tab" class="add-tab-content">
  <div class="bg-white border border-gray-200 rounded p-3 sm:p-4">
    <div id="add-status" class="hidden text-xs sm:text-sm mb-2"></div>
    <div id="link-preview" class="hidden mb-4"></div>
    <form id="add-form" class="space-y-3">
      <input type="hidden" name="title" value="{{ prefill.title }}" />
      <div>
        <label class="block text-xs sm:text-sm font-medium text-gray-900 mb-1.5">URL</label>
        <input type="url" name="url" required value="{{ prefill.url }}" placeholder="https://example.com/article"
          class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
      </div>
      <button type="submit"
        class="w-full sm:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-medium text-sm hover:bg-indigo-700 transition">Save
        link</button>
    </form>
  </div>
</div>

<!-- Bulk Import Tab -->
<div id="bulk-tab" class="add-tab-content hidden">
  <div class="bg-white border border-gray-200 rounded p-3 sm:p-4">
    {% if bulk_success_message %}
    <div
      class="mb-4 rounded border-l-4 border-green-500 bg-green-50 px-3 sm:px-4 py-3 text-xs sm:text-sm text-green-800">
      {{ bulk_success_message }}</div>
    {% endif %}
    {% if bulk_error_message %}
    <div class="mb-4 rounded border-l-4 border-red-500 bg-red-50 px-3 sm:px-4 py-3 text-xs sm:text-sm text-red-800">{{
      bulk_error_message }}</div>
    {% endif %}

    <h3 class="text-sm sm:text-lg font-medium text-gray-900 mb-2 sm:mb-3">Import Multiple Links</h3>
    <p class="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4">Paste multiple URLs or upload a CSV file to add them all at
      once.</p>

    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded">
      <p class="text-xs sm:text-sm font-medium text-blue-900 mb-2">Accepted Formats:</p>
      <ul class="text-xs text-blue-800 space-y-1 ml-4 list-disc">
        <li><strong>Text input - One URL per line:</strong> https://example.com</li>
        <li><strong>Text input - URL with title:</strong> https://example.com | My Article Title</li>
        <li><strong>CSV file:</strong> Headers: url, title (optional), notes (optional), tags (optional)</li>
      </ul>
      <p class="text-xs text-blue-700 mt-2">✓ Blank lines will be ignored<br>✓ Invalid URLs will be skipped<br>✓ CSV
        Example: url,title,tags<br>&nbsp;&nbsp;https://example.com,My Article,tech</p>
    </div>

    <!-- Text Input Form -->
    <form action="/bulk-import" method="post" class="space-y-3 mb-4 sm:mb-6">
      <div>
        <label class="block text-xs sm:text-sm font-medium text-gray-900 mb-1.5">Paste URLs (one per line)</label>
        <textarea name="urls" rows="8"
          placeholder="https://example.com/article1&#10;https://example.com/article2 | Important Article&#10;https://example.com/article3"
          class="w-full px-3 py-2 border border-gray-300 rounded text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-y font-mono"></textarea>
      </div>
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <p class="text-xs text-gray-500">Tip: You can copy-paste from a bookmarks export or reading list</p>
        <button type="submit"
          class="w-full sm:w-auto px-4 py-2 bg-indigo-600 text-white rounded font-medium text-sm hover:bg-indigo-700 transition">
          Import from Text
        </button>
      </div>
    </form>

    <!-- Divider -->
    <div class="relative my-4 sm:my-6">
      <div class="absolute inset-0 flex items-center">
        <div class="w-full border-t border-gray-300"></div>
      </div>
      <div class="relative flex justify-center text-xs sm:text-sm">
        <span class="px-2 bg-white text-gray-500">OR</span>
      </div>
    </div>

    <!-- CSV Upload Form -->
    <form action="/bulk-import-csv" method="post" enctype="multipart/form-data" class="space-y-3">
      <div>
        <label class="block text-xs sm:text-sm font-medium text-gray-900 mb-1.5">Upload CSV File</label>
        <input type="file" name="file" accept=".csv,text/csv" required
          class="block w-full text-xs sm:text-sm text-gray-900 border border-gray-300 rounded cursor-pointer bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 px-3 py-2" />
      </div>
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <p class="text-xs text-gray-500">CSV should have headers: url, title (optional), notes (optional), tags
          (optional)</p>
        <button type="submit"
          class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded font-medium text-sm hover:bg-green-700 transition">
          Import from CSV
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Note Tab -->
<div id="note-tab" class="add-tab-content hidden">
  <div class="bg-white border border-gray-200 rounded p-3 sm:p-4">
    <h3 class="text-sm sm:text-lg font-medium text-gray-900 mb-2 sm:mb-3">Create Personal Note</h3>
    <p class="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4">
      Create a standalone note without a URL - perfect for ideas, thoughts, and reminders.
    </p>

    <form action="/notes/create" method="post" enctype="multipart/form-data" class="space-y-4">
      <!-- Title -->
      <div>
        <label for="note-title" class="block text-xs sm:text-sm font-medium text-gray-900 mb-1.5">
          Title <span class="text-red-500">*</span>
        </label>
        <input type="text" id="note-title" name="title" required
          placeholder="My Important Note"
          class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
      </div>

      <!-- Content -->
      <div>
        <label for="note-content" class="block text-xs sm:text-sm font-medium text-gray-900 mb-1.5">
          Content <span class="text-red-500">*</span>
        </label>
        <textarea id="note-content" name="content" rows="8" required
          placeholder="Write your note here...&#10;&#10;You can write as much as you need!"
          class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-y font-mono"></textarea>
      </div>

      <!-- Image Upload -->
      <div>
        <label for="note-image" class="block text-xs sm:text-sm font-medium text-gray-900 mb-1.5">
          Image (optional)
        </label>
        <input type="file" id="note-image" name="image" accept="image/*"
          class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100" />
        <p class="text-xs text-gray-500 mt-1">Image will be compressed to under 100KB</p>
        <div id="note-image-preview" class="mt-2 hidden">
          <img id="note-preview-img" src="" alt="Preview" class="max-w-full max-h-48 rounded border border-gray-200" />
          <button type="button" onclick="clearNoteImage()" class="mt-1 text-xs text-red-600 hover:text-red-800">Remove image</button>
        </div>
      </div>

      <!-- Tags -->
      <div>
        <label class="block text-xs sm:text-sm font-medium text-gray-900 mb-1.5">
          Tags (optional)
        </label>
        
        <!-- Hidden input to store selected tag slugs -->
        <input type="hidden" id="note-tags-input" name="tags" value="" />
        
        <!-- Selected tags display -->
        <div id="note-selected-tags" class="flex flex-wrap gap-2 mb-2"></div>
        
        <!-- Tag combobox -->
        <div class="relative">
          <input
            type="text"
            id="note-tag-search"
            placeholder="Type to search tags..."
            autocomplete="off"
            class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          />
          <div id="note-tag-dropdown" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
            <div id="note-tag-suggestions" class="py-1"></div>
          </div>
        </div>
        <p class="text-xs text-gray-500 mt-1">Maximum 4 tags</p>
        <p id="note-tag-warning" class="text-xs text-red-600 mt-1 hidden">You can only add up to 4 tags</p>
      </div>

      <!-- Collection -->
      <div>
        <label for="note-collection" class="block text-xs sm:text-sm font-medium text-gray-900 mb-1.5">
          Collection (optional)
        </label>
        <input type="text" id="note-collection" name="collection"
          placeholder="Personal, Work, Ideas..."
          class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" />
      </div>

      <!-- Submit Button -->
      <div class="flex items-center gap-3">
        <button type="submit"
          class="px-5 py-2.5 bg-purple-600 text-white rounded-lg font-medium text-sm hover:bg-purple-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
          <i data-lucide="save" class="w-4 h-4"></i>
          Create Note
        </button>
        <a href="/links" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">
          View all items
        </a>
      </div>
    </form>
  </div>
</div>

<script>
  // client side form validation
  document.getElementById('add-form').addEventListener('submit', (e) => {
    const url = e.target.url.value;
    if (!url || !url.match(/^https?:\/\/.+/)) {
      e.preventDefault();
      alert('Please enter a valid URL starting with http:// or https://');
    }
  });
  
  document.querySelectorAll('.add-tab-button').forEach(btn => {
    btn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        switchAddTab(btn.dataset.addTab);
      }
    });
  });

  function switchAddTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.add-tab-button').forEach(btn => {
      if (btn.dataset.addTab === tabName) {
        btn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
        btn.classList.add('border-indigo-600', 'text-indigo-600');
      } else {
        btn.classList.remove('border-indigo-600', 'text-indigo-600');
        btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');
      }
    });

    // Update tab content
    document.querySelectorAll('.add-tab-content').forEach(content => {
      content.classList.add('hidden');
    });
    document.getElementById(tabName + '-tab').classList.remove('hidden');

    // Update URL hash
    window.location.hash = tabName === 'single' ? '' : tabName;
  }

  // Check URL hash for active tab
  window.addEventListener('DOMContentLoaded', () => {
    const hash = window.location.hash.substring(1);
    if (hash === 'bulk') {
      switchAddTab('bulk');
    }
  });

  // Image preview for note creation
  document.getElementById('note-image')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('note-image-preview');
    const previewImg = document.getElementById('note-preview-img');
    
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        preview.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    } else {
      preview.classList.add('hidden');
    }
  });

  function clearNoteImage() {
    document.getElementById('note-image').value = '';
    document.getElementById('note-image-preview').classList.add('hidden');
  }

  // Tag combobox for note creation
  const availableTags = {{ available_tags | tojson }};
  const selectedNoteTags = [];
  const MAX_TAGS = 4;

  const noteTagSearch = document.getElementById('note-tag-search');
  const noteTagDropdown = document.getElementById('note-tag-dropdown');
  const noteTagSuggestions = document.getElementById('note-tag-suggestions');
  const noteSelectedTagsContainer = document.getElementById('note-selected-tags');
  const noteTagsInput = document.getElementById('note-tags-input');
  const noteTagWarning = document.getElementById('note-tag-warning');

  let noteActiveSuggestionIndex = -1;

  function renderNoteSelectedTags() {
    noteSelectedTagsContainer.innerHTML = selectedNoteTags.map(tag => {
      const iconHtml = tag.icon ? `<i data-lucide="${tag.icon}" class="w-3 h-3"></i>` : '';
      const colorClass = tag.color ? `bg-${tag.color}-100 text-${tag.color}-700 border-${tag.color}-200` : 'bg-gray-100 text-gray-700 border-gray-200';
      return `
        <span class="inline-flex items-center gap-1 px-2 py-1 ${colorClass} border rounded text-xs">
          ${iconHtml}
          <span>${tag.name}</span>
          <button type="button" onclick="removeNoteTag('${tag.slug}')" class="ml-1 hover:text-red-600">
            <i data-lucide="x" class="w-3 h-3"></i>
          </button>
        </span>
      `;
    }).join('');
    
    // Update hidden input
    noteTagsInput.value = selectedNoteTags.map(t => t.slug).join(',');
    
    // Reinitialize lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }

    // Show/hide warning
    if (selectedNoteTags.length >= MAX_TAGS) {
      noteTagWarning.classList.remove('hidden');
      noteTagSearch.disabled = true;
      noteTagSearch.placeholder = 'Maximum tags reached';
    } else {
      noteTagWarning.classList.add('hidden');
      noteTagSearch.disabled = false;
      noteTagSearch.placeholder = 'Type to search tags...';
    }
  }

  function removeNoteTag(slug) {
    const index = selectedNoteTags.findIndex(t => t.slug === slug);
    if (index > -1) {
      selectedNoteTags.splice(index, 1);
      renderNoteSelectedTags();
    }
  }

  function addNoteTag(tag) {
    if (selectedNoteTags.length >= MAX_TAGS) {
      return;
    }
    if (!selectedNoteTags.find(t => t.slug === tag.slug)) {
      selectedNoteTags.push(tag);
      renderNoteSelectedTags();
      noteTagSearch.value = '';
      renderNoteSuggestions('');
    }
  }

  function renderNoteSuggestions(query) {
    const lowerQuery = query.toLowerCase();
    const filtered = availableTags.filter(tag => 
      tag.name.toLowerCase().includes(lowerQuery) &&
      !selectedNoteTags.find(t => t.slug === tag.slug)
    );

    if (filtered.length === 0) {
      noteTagDropdown.classList.add('hidden');
      return;
    }

    noteTagSuggestions.innerHTML = filtered.map((tag, index) => {
      const iconHtml = tag.icon ? `<i data-lucide="${tag.icon}" class="w-4 h-4"></i>` : '';
      const colorClass = tag.color ? `bg-${tag.color}-50 text-${tag.color}-700` : 'bg-gray-50 text-gray-700';
      return `
        <button
          type="button"
          data-tag-index="${index}"
          data-tag-slug="${tag.slug}"
          class="note-tag-suggestion w-full px-3 py-2 text-left hover:bg-gray-100 flex items-center gap-2 text-sm"
        >
          <span class="inline-flex items-center gap-1 px-2 py-0.5 ${colorClass} rounded text-xs">
            ${iconHtml}
            <span>${tag.name}</span>
          </span>
        </button>
      `;
    }).join('');

    noteTagDropdown.classList.remove('hidden');
    noteActiveSuggestionIndex = -1;

    // Reinitialize lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }

    // Add click handlers
    document.querySelectorAll('.note-tag-suggestion').forEach((btn, idx) => {
      btn.addEventListener('click', () => {
        const slug = btn.dataset.tagSlug;
        const tag = filtered.find(t => t.slug === slug);
        if (tag) addNoteTag(tag);
      });
    });
  }

  noteTagSearch?.addEventListener('input', (e) => {
    renderNoteSuggestions(e.target.value);
  });

  noteTagSearch?.addEventListener('focus', () => {
    renderNoteSuggestions(noteTagSearch.value);
  });

  noteTagSearch?.addEventListener('keydown', (e) => {
    const suggestions = document.querySelectorAll('.note-tag-suggestion');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      noteActiveSuggestionIndex = Math.min(noteActiveSuggestionIndex + 1, suggestions.length - 1);
      updateNoteActiveSuggestion(suggestions);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      noteActiveSuggestionIndex = Math.max(noteActiveSuggestionIndex - 1, -1);
      updateNoteActiveSuggestion(suggestions);
    } else if (e.key === 'Enter' && noteActiveSuggestionIndex >= 0) {
      e.preventDefault();
      suggestions[noteActiveSuggestionIndex]?.click();
    } else if (e.key === 'Escape') {
      noteTagDropdown.classList.add('hidden');
      noteActiveSuggestionIndex = -1;
    } else if (e.key === 'Tab') {
      noteTagDropdown.classList.add('hidden');
      noteActiveSuggestionIndex = -1;
    }
  });

  function updateNoteActiveSuggestion(suggestions) {
    suggestions.forEach((s, idx) => {
      if (idx === noteActiveSuggestionIndex) {
        s.classList.add('bg-gray-100');
      } else {
        s.classList.remove('bg-gray-100');
      }
    });
  }

  // Click outside to close dropdown
  document.addEventListener('click', (e) => {
    if (!noteTagSearch?.contains(e.target) && !noteTagDropdown?.contains(e.target)) {
      noteTagDropdown?.classList.add('hidden');
    }
  });

  // Make removeNoteTag globally accessible
  window.removeNoteTag = removeNoteTag;

</script>
{% endblock %}
{% block extra_scripts %}
<script src="{{ url_for('static', path='/js/add.js') }}" type="module"></script>
{% endblock %}