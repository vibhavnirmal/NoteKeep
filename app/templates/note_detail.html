{% extends "base.html" %}
{% block title %}{{ note.title }} Â· NoteKeep{% endblock %}
{% block content %}

<div class="max-w-4xl mx-auto">
    <!-- Back Button -->
    <div class="mb-4">
        <a href="/links" class="inline-flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 transition-colors">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            Back to All Items
        </a>
    </div>

    {% if updated %}
    <div class="mb-6 rounded-xl border-l-4 border-green-500 bg-green-50 px-5 py-4 text-sm text-green-800 shadow-sm flex items-start gap-3">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"></i>
        <span>Note updated successfully!</span>
    </div>
    {% endif %}

    <!-- View Mode (default) -->
    <div id="view-mode" class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 sm:p-8">
        <!-- Title -->
        <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ note.title }}</h1>

        <!-- Image Display -->
        {% if note.image_url %}
        <div class="mb-6">
            <img src="{{ note.image_url }}" alt="Note image" class="max-w-full max-h-96 rounded-lg border border-gray-200 shadow-sm" />
        </div>
        {% endif %}

        <!-- Content -->
        <div class="mb-6">
            <div class="prose max-w-none">
                <pre class="whitespace-pre-wrap font-sans text-base text-gray-700 leading-relaxed">{{ note.content }}</pre>
            </div>
        </div>

        <!-- Tags -->
        {% if note.tags %}
        <div class="mb-6">
            <h3 class="text-sm font-semibold text-gray-900 mb-2">Tags</h3>
            <div class="flex flex-wrap gap-2">
                {% for tag in note.tags %}
                <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium transition-all"
                    style="{% if tag.icon %}background-color: {{ tag.color or '#6b7280' }}; color: #ffffff;{% else %}background-color: #eef2ff; color: #4f46e5;{% endif %}">
                    {% if tag.icon %}
                    <i data-lucide="{{ tag.icon }}" class="w-4 h-4"></i>
                    {% else %}
                    <i data-lucide="tag" class="w-4 h-4"></i>
                    {% endif %}
                    <span>{{ tag.name }}</span>
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Collection -->
        {% if note.collection %}
        <div class="mb-6">
            <h3 class="text-sm font-semibold text-gray-900 mb-2">Collection</h3>
            <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium">
                <i data-lucide="folder" class="w-4 h-4"></i>
                <span>{{ note.collection.name }}</span>
            </span>
        </div>
        {% endif %}

        <!-- Metadata -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="text-gray-500">Created:</span>
                    <span class="text-gray-900 font-medium ml-2">{{ note.created_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
                </div>
                <div>
                    <span class="text-gray-500">Updated:</span>
                    <span class="text-gray-900 font-medium ml-2">{{ note.updated_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center justify-between gap-3">
            <button type="button" onclick="deleteNote()"
                class="px-5 py-2.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
                Delete Note
            </button>
            <button type="button" onclick="toggleEditMode()"
                class="px-5 py-2.5 bg-purple-600 text-white rounded-lg font-medium text-sm hover:bg-purple-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                <i data-lucide="edit" class="w-4 h-4"></i>
                Edit Note
            </button>
        </div>
    </div>

    <!-- Edit Mode (hidden by default) -->
    <div id="edit-mode" class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 sm:p-8 hidden">
        <form method="post" action="/notes/{{ note.id }}/update" enctype="multipart/form-data">
            <!-- Title -->
            <div class="mb-6">
                <label for="title" class="block text-sm font-semibold text-gray-900 mb-2">Title</label>
                <input type="text" id="title" name="title" value="{{ note.title }}" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all shadow-sm" />
            </div>

            <!-- Content -->
            <div class="mb-6">
                <label for="content" class="block text-sm font-semibold text-gray-900 mb-2">Content</label>
                <textarea id="content" name="content" rows="12" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all shadow-sm font-mono"
                    placeholder="Write your note here...">{{ note.content }}</textarea>
            </div>

            <!-- Image Upload/Display -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-900 mb-2">Image</label>
                {% if note.image_url %}
                <div class="mb-3 relative inline-block">
                    <img src="{{ note.image_url }}" alt="Note image" class="max-w-full max-h-64 rounded-lg border border-gray-200 shadow-sm" />
                    <div class="mt-2 flex items-center gap-3">
                        <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                            <input type="checkbox" name="remove_image" value="true" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500" />
                            Remove current image
                        </label>
                    </div>
                </div>
                {% endif %}
                <input type="file" id="image" name="image" accept="image/*"
                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100" />
                <p class="text-xs text-gray-500 mt-1">{% if note.image_url %}Upload new image to replace current{% else %}Upload an image (will be compressed to under 100KB){% endif %}</p>
                <div id="image-preview" class="mt-2 hidden">
                    <img id="preview-img" src="" alt="Preview" class="max-w-full max-h-48 rounded border border-gray-200" />
                    <button type="button" onclick="clearImage()" class="mt-1 text-xs text-red-600 hover:text-red-800">Cancel new image</button>
                </div>
            </div>

            <!-- Tags -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-900 mb-2">Tags</label>
                <div class="space-y-2" data-tag-combobox>
                    <div class="flex flex-wrap gap-2 min-h-[2.25rem] rounded-lg border border-dashed border-gray-200 bg-gray-50 px-3 py-2"
                        data-selected-tags>
                        <span class="text-xs text-gray-500" data-empty-placeholder>Start typing to add tags</span>
                    </div>
                    <div class="relative">
                        <input type="text" data-tag-input autocomplete="off"
                            class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all"
                            placeholder="Start typing to search or add a tag" />
                        <div class="absolute z-40 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-48 overflow-y-auto hidden"
                            data-tag-suggestions></div>
                    </div>
                    <input type="hidden" name="tags" id="tags-input" value="{{ note.tags | map(attribute='name') | join(', ') }}" />
                    <p class="text-xs text-gray-500">Add up to 4 tags. Press Enter to create a new tag or choose from the list.</p>
                    <p class="text-xs text-red-600 hidden" data-tag-limit-warning>You can choose up to 4 tags. Remove one to add another.</p>
                </div>
            </div>

            <!-- Collection -->
            <div class="mb-6">
                <label for="collection" class="block text-sm font-semibold text-gray-900 mb-2">Collection</label>
                <input type="text" id="collection" name="collection" 
                    value="{{ note.collection.name if note.collection else '' }}"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all shadow-sm"
                    placeholder="Personal, Work, Ideas..." />
            </div>

            <!-- Metadata -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">Created:</span>
                        <span class="text-gray-900 font-medium ml-2">{{ note.created_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
                    </div>
                    <div>
                        <span class="text-gray-500">Updated:</span>
                        <span class="text-gray-900 font-medium ml-2">{{ note.updated_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-between gap-3">
                <button type="button" onclick="deleteNote()"
                    class="px-5 py-2.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    Delete Note
                </button>
                <div class="flex gap-3">
                    <button type="button" onclick="cancelEdit()"
                        class="px-5 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-medium text-sm hover:bg-gray-200 transition-all shadow-sm">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-5 py-2.5 bg-purple-600 text-white rounded-lg font-medium text-sm hover:bg-purple-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Save Changes
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
        <div class="p-6">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Delete Note?</h3>
                    <p class="text-sm text-gray-600">This action cannot be undone.</p>
                </div>
            </div>
            <div class="flex gap-3 justify-end">
                <button type="button" onclick="closeDeleteModal()"
                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium text-sm hover:bg-gray-200 transition-all">
                    Cancel
                </button>
                <form method="post" action="/notes/{{ note.id }}/delete" class="inline">
                    <button type="submit"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700 transition-all">
                        Delete Note
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="collection-data">{{ collections | map(attribute='name') | list | tojson }}</script>
<script type="application/json" id="tag-data">{{ available_tags | default([], true) | tojson }}</script>

<script>
function toggleEditMode() {
    const viewMode = document.getElementById('view-mode');
    const editMode = document.getElementById('edit-mode');
    
    viewMode.classList.add('hidden');
    editMode.classList.remove('hidden');
    
    // Focus on title input
    document.getElementById('title').focus();
}

function cancelEdit() {
    const viewMode = document.getElementById('view-mode');
    const editMode = document.getElementById('edit-mode');
    
    viewMode.classList.remove('hidden');
    editMode.classList.add('hidden');
}

function deleteNote() {
    document.getElementById('delete-modal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('delete-modal').classList.add('hidden');
}

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeDeleteModal();
        // Also exit edit mode if in edit mode
        const editMode = document.getElementById('edit-mode');
        if (!editMode.classList.contains('hidden')) {
            cancelEdit();
        }
    }
});

// Image preview for note update
document.getElementById('image')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    } else {
        preview.classList.add('hidden');
    }
});

function clearImage() {
    document.getElementById('image').value = '';
    document.getElementById('image-preview').classList.add('hidden');
}

// Tag combobox initialization
document.addEventListener('DOMContentLoaded', () => {
    const tagDataEl = document.getElementById('tag-data');
    const tagsInput = document.getElementById('tags-input');
    const comboboxRoot = document.querySelector('[data-tag-combobox]');

    if (!tagDataEl || !tagsInput || !comboboxRoot) {
        return;
    }

    const tagOptions = JSON.parse(tagDataEl.textContent) || [];
    const MAX_TAGS = 4;

    const normalizeTagName = (value) => (value || '').trim().toLowerCase();
    const tagMetadata = new Map(
        tagOptions.map((tag) => [normalizeTagName(tag.name), { icon: tag.icon || null, color: tag.color || null }]),
    );

    const selectedContainer = comboboxRoot.querySelector('[data-selected-tags]');
    const emptyPlaceholder = comboboxRoot.querySelector('[data-empty-placeholder]');
    const tagTextInput = comboboxRoot.querySelector('[data-tag-input]');
    const suggestionPanel = comboboxRoot.querySelector('[data-tag-suggestions]');
    const warningEl = comboboxRoot.querySelector('[data-tag-limit-warning]');

    if (!selectedContainer || !tagTextInput || !suggestionPanel) {
        return;
    }

    let selectedTags = [];
    let filteredSuggestions = [];
    let highlightedIndex = -1;

    const parseTags = (value) => {
        const seen = new Set();
        const result = [];
        value.split(',').forEach((raw) => {
            const trimmed = raw.trim();
            if (!trimmed) return;
            const key = normalizeTagName(trimmed);
            if (seen.has(key)) return;
            seen.add(key);
            result.push(trimmed);
        });
        return result.slice(0, MAX_TAGS);
    };

    const updateHiddenInput = () => {
        tagsInput.value = selectedTags.join(', ');
    };

    const showWarning = (visible) => {
        if (!warningEl) return;
        warningEl.classList.toggle('hidden', !visible);
        if (tagTextInput) {
            if (visible) {
                tagTextInput.classList.add('border-red-400', 'focus:ring-red-500', 'focus:border-red-500');
            } else {
                tagTextInput.classList.remove('border-red-400', 'focus:ring-red-500', 'focus:border-red-500');
            }
        }
    };

    const createSuggestionIcon = (iconName, color) => {
        const iconEl = document.createElement('i');
        iconEl.dataset.lucide = iconName;
        iconEl.className = 'w-4 h-4 flex-shrink-0';
        if (color) {
            iconEl.style.color = color;
        } else {
            iconEl.classList.add('text-gray-500');
        }
        return iconEl;
    };

    const renderSelectedTags = () => {
        if (!selectedContainer) return;
        selectedContainer.querySelectorAll('[data-tag-pill]').forEach((pill) => pill.remove());
        selectedTags.forEach((tag) => {
            const pill = document.createElement('span');
            pill.dataset.tagPill = 'true';
            pill.className = 'inline-flex items-center gap-2 bg-white border border-gray-300 text-sm text-gray-700 px-3 py-1.5 rounded-full shadow-sm';

            const metadata = tagMetadata.get(normalizeTagName(tag));
            if (metadata && metadata.icon) {
                const iconWrapper = document.createElement('span');
                iconWrapper.className = 'flex items-center justify-center';
                const iconEl = createSuggestionIcon(metadata.icon, metadata.color);
                iconWrapper.appendChild(iconEl);
                pill.appendChild(iconWrapper);
            }

            const label = document.createElement('span');
            label.textContent = tag;
            label.className = 'max-w-[8rem] truncate';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'flex items-center justify-center w-5 h-5 rounded-full bg-gray-200 hover:bg-red-100 text-gray-600 hover:text-red-600 transition';
            removeBtn.innerHTML = '<svg class="w-3 h-3" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.5 3.5l7 7m0-7l-7 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            removeBtn.addEventListener('click', () => removeTag(tag));

            pill.appendChild(label);
            pill.appendChild(removeBtn);
            selectedContainer.appendChild(pill);
        });

        if (emptyPlaceholder) {
            emptyPlaceholder.classList.toggle('hidden', selectedTags.length > 0);
        }

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    };

    const setSelectedTags = (tags) => {
        const unique = [];
        const seen = new Set();
        tags.forEach((tag) => {
            const trimmed = tag.trim();
            if (!trimmed) return;
            const key = normalizeTagName(trimmed);
            if (seen.has(key)) return;
            seen.add(key);
            unique.push(trimmed);
        });
        selectedTags = unique.slice(0, MAX_TAGS);
        updateHiddenInput();
        renderSelectedTags();
        updateSuggestions(tagTextInput ? tagTextInput.value : '');
        if (selectedTags.length < MAX_TAGS) {
            showWarning(false);
        }
    };

    const addTag = (tag) => {
        const trimmed = tag.trim();
        if (!trimmed) return;
        const key = normalizeTagName(trimmed);
        if (selectedTags.some((existing) => normalizeTagName(existing) === key)) return;
        if (selectedTags.length >= MAX_TAGS) {
            showWarning(true);
            return;
        }
        setSelectedTags([...selectedTags, trimmed]);
    };

    const removeTag = (tag) => {
        const key = normalizeTagName(tag);
        setSelectedTags(selectedTags.filter((existing) => normalizeTagName(existing) !== key));
    };

    const hideSuggestions = () => {
        if (!suggestionPanel) return;
        suggestionPanel.classList.add('hidden');
        suggestionPanel.innerHTML = '';
        filteredSuggestions = [];
        highlightedIndex = -1;
    };

    const highlightSuggestion = (index) => {
        if (!suggestionPanel) return;
        const items = suggestionPanel.querySelectorAll('[data-suggestion]');
        if (!items.length) {
            highlightedIndex = -1;
            return;
        }
        if (index < 0 || index >= items.length) {
            highlightedIndex = -1;
            items.forEach((item) => item.classList.remove('bg-purple-50', 'text-purple-700'));
            return;
        }
        items.forEach((item, idx) => {
            if (idx === index) {
                item.classList.add('bg-purple-50', 'text-purple-700');
            } else {
                item.classList.remove('bg-purple-50', 'text-purple-700');
            }
        });
        highlightedIndex = index;
    };

    const renderSuggestions = (matches) => {
        if (!suggestionPanel) return;
        suggestionPanel.innerHTML = '';
        filteredSuggestions = matches;
        if (!matches.length) {
            hideSuggestions();
            return;
        }

        matches.forEach((tag, index) => {
            const item = document.createElement('button');
            item.type = 'button';
            item.dataset.suggestion = 'true';
            item.className = 'w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-purple-50 transition flex items-center gap-3';

            if (tag.icon) {
                const iconEl = createSuggestionIcon(tag.icon, tag.color);
                item.appendChild(iconEl);
            }

            const label = document.createElement('span');
            label.className = 'flex-1 truncate';
            label.textContent = tag.name;
            item.appendChild(label);

            item.addEventListener('mouseenter', () => highlightSuggestion(index));
            item.addEventListener('mousedown', (event) => event.preventDefault());
            item.addEventListener('click', () => {
                addTag(tag.name);
                clearTagInput();
                hideSuggestions();
            });
            suggestionPanel.appendChild(item);
        });

        suggestionPanel.classList.remove('hidden');
        highlightSuggestion(0);

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    };

    const updateSuggestions = (query, showWhenEmpty = false) => {
        if (!tagTextInput) return;
        const normalizedQuery = query.trim().toLowerCase();
        const selectedKeys = new Set(selectedTags.map(normalizeTagName));
        const shouldHide = !normalizedQuery && !showWhenEmpty;
        if (shouldHide) {
            hideSuggestions();
            return;
        }
        const matches = tagOptions
            .filter((tag) => {
                if (selectedKeys.has(normalizeTagName(tag.name))) return false;
                if (!normalizedQuery) return true;
                return tag.name.toLowerCase().includes(normalizedQuery);
            })
            .slice(0, 8);
        renderSuggestions(matches);
    };

    const clearTagInput = () => {
        if (tagTextInput) {
            tagTextInput.value = '';
        }
    };

    const moveHighlight = (delta) => {
        if (!filteredSuggestions.length) return;
        let newIndex = highlightedIndex;
        if (newIndex === -1) {
            newIndex = 0;
        }
        newIndex = (newIndex + delta + filteredSuggestions.length) % filteredSuggestions.length;
        highlightSuggestion(newIndex);
    };

    tagTextInput.addEventListener('focus', () => {
        updateSuggestions(tagTextInput.value, true);
    });

    tagTextInput.addEventListener('input', (event) => {
        showWarning(false);
        updateSuggestions(event.target.value, true);
    });

    tagTextInput.addEventListener('keydown', (event) => {
        switch (event.key) {
            case 'ArrowDown':
                event.preventDefault();
                if (suggestionPanel.classList.contains('hidden')) {
                    updateSuggestions(tagTextInput.value, true);
                }
                moveHighlight(1);
                break;
            case 'ArrowUp':
                event.preventDefault();
                moveHighlight(-1);
                break;
            case 'Enter':
                event.preventDefault();
                if (highlightedIndex >= 0 && filteredSuggestions[highlightedIndex]) {
                    addTag(filteredSuggestions[highlightedIndex].name);
                    clearTagInput();
                    hideSuggestions();
                } else {
                    addTag(tagTextInput.value);
                    clearTagInput();
                    hideSuggestions();
                }
                break;
            case 'Tab':
                if (!suggestionPanel.classList.contains('hidden') && highlightedIndex >= 0 && filteredSuggestions[highlightedIndex]) {
                    event.preventDefault();
                    addTag(filteredSuggestions[highlightedIndex].name);
                    clearTagInput();
                    hideSuggestions();
                }
                break;
            case ',':
                event.preventDefault();
                addTag(tagTextInput.value);
                clearTagInput();
                hideSuggestions();
                break;
            case 'Backspace':
                if (!tagTextInput.value && selectedTags.length) {
                    removeTag(selectedTags[selectedTags.length - 1]);
                    hideSuggestions();
                }
                break;
            case 'Escape':
                hideSuggestions();
                break;
            default:
                break;
        }
    });

    document.addEventListener('click', (event) => {
        if (!comboboxRoot.contains(event.target)) {
            hideSuggestions();
        }
    });

    setSelectedTags(parseTags(tagsInput.value));
    hideSuggestions();

    // Initialize lucide icons on page load
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>

{% endblock %}
