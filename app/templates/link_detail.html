{% extends "base.html" %}

{% block title %}{{ link.title or link.url }} - NoteKeep{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Back button -->
    <!-- <div class="m-4">
        <a href="/links" class="inline-flex items-center gap-2 text-gray-600 hover:text-primary-600 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Links
        </a>
    </div> -->

    <!-- Link Detail Card -->
    <article class="{% if link.link_status == 'broken' %}bg-red-50 border-red-200{% elif link.link_status == 'unreachable' or link.link_status == 'error' %}bg-orange-50 border-orange-200{% endif %}">
        <!-- Header -->
        <div class="flex flex-col p-3 border-b border-gray-200">
            <div class="flex items-start gap-2 mb-2">
                <h1 class="text-base sm:text-lg font-bold {% if link.link_status == 'broken' %}text-red-700 line-through{% elif link.link_status == 'unreachable' or link.link_status == 'error' %}text-orange-700{% else %}text-gray-900{% endif %} break-words max-w-full flex-1">{{ link.title or link.url }}</h1>
                {% if link.link_status == 'broken' %}
                <div class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium border border-red-300 flex-shrink-0">
                    <i data-lucide="alert-circle" class="w-4 h-4"></i>
                    <span>Link Broken</span>
                </div>
                {% elif link.link_status == 'unreachable' %}
                <div class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium border border-orange-300 flex-shrink-0">
                    <i data-lucide="wifi-off" class="w-4 h-4"></i>
                    <span>Unreachable</span>
                </div>
                {% elif link.link_status == 'error' %}
                <div class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium border border-orange-300 flex-shrink-0">
                    <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                    <span>Error</span>
                </div>
                {% endif %}
            </div>
            {% if link.link_status == 'broken' or link.link_status == 'unreachable' or link.link_status == 'error' %}
            <div class="mb-2 p-2 bg-white rounded border {% if link.link_status == 'broken' %}border-red-200{% else %}border-orange-200{% endif %}">
                <p class="text-xs text-gray-600">
                    <strong>Status:</strong> 
                    {% if link.http_status_code %}HTTP {{ link.http_status_code }}{% else %}Connection failed{% endif %}
                    {% if link.last_checked_at %}
                    • Last checked: {{ link.last_checked_at.strftime('%Y-%m-%d %H:%M') }}
                    {% endif %}
                </p>
                {% if link.link_status == 'broken' %}
                <p class="text-xs text-red-600 mt-1">⚠️ This link appears to be deleted or no longer exists.</p>
                {% endif %}
            </div>
            {% endif %}
            <a href="{{ link.url }}" target="_blank" rel="noopener"
                class="inline-flex items-center gap-2 text-primary-600 hover:text-primary-700 transition-colors break-all">
                <i data-lucide="external-link" class="w-3 h-3 flex-shrink-0"></i>
                <span class="text-sm">{{ link.url }}</span>
            </a>
        </div>

        <!-- Preview Image -->
        {% if link.image_url %}
        <div class="p-3 border-b border-gray-200">
            <div class="rounded-lg overflow-hidden border border-gray-200 bg-gray-50">
                <img src="{{ link.image_url }}" 
                     alt="{{ link.title or 'Link preview' }}"
                     class="w-full h-auto max-h-96 object-contain"
                     onerror="this.parentElement.style.display='none'">
            </div>
        </div>
        {% endif %}

        <!-- Details -->
        <div class="p-3 space-y-3">
            <!-- Collection -->
            {% if link.collection %}
            <div>
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Collection</h3>
                <a href="/links?collection={{ link.collection.slug }}"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-blue-50 text-blue-700 border border-blue-200 hover:bg-blue-100 hover:border-blue-300 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    {{ link.collection.name }}
                </a>
            </div>
            {% endif %}

            <!-- Tags -->
            {% if link.tags %}
            <div>
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Tags</h3>
                <div class="flex flex-wrap gap-2">
                    {% for tag in link.tags %}
                    <div class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium {% if tag.icon %}shadow-sm{% else %}bg-indigo-50 text-indigo-700{% endif %} hover:opacity-80 transition"
                        style="{% if tag.icon %}background-color: {{ tag.color or '#6b7280' }}; color: #ffffff;{% endif %}">
                        {% if tag.icon %}
                        <i data-lucide="{{ tag.icon }}" class="w-4 h-4"></i>
                        {% else %}
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                        {% endif %}
                        {{ tag.name }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Notes -->
            {% if link.notes %}
            <div>
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Notes</h3>
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <p class="text-gray-700 whitespace-pre-wrap">{{ link.notes }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Metadata -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4 border-t border-gray-200 text-sm">
                <div>
                    <h3 class="text-xs font-semibold text-gray-700 mb-1">Added</h3>
                    <p class="text-gray-600 flex items-center gap-2">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        {{ link.created_at | format_date }} ({{ link.created_at | relative_time }})
                    </p>
                </div>
                <div>
                    <h3 class="text-xs font-semibold text-gray-700 mb-1">Last Updated</h3>
                    <p class="text-gray-600 flex items-center gap-2">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        {{ link.updated_at | format_date }} ({{ link.updated_at | relative_time }})
                    </p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="p-3 border-t border-gray-200 bg-gray-50 flex gap-3">
            <button type="button" onclick="toggleEdit()"
                class="flex-1 inline-flex items-center text-sm justify-center gap-2 px-4 py-2.5 bg-primary-600 text-white rounded-lg font-medium hover:bg-primary-700 transition-all shadow-md">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Edit
            </button>
            <button type="button" onclick="showDeleteModal()"
                class="px-4 py-2.5 bg-red-50 text-red-600 text-sm border border-red-200 rounded-lg font-medium hover:bg-red-100 transition-all inline-flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Delete
            </button>
        </div>

        <!-- Edit Form (hidden by default) -->
        <div id="edit-form" class="hidden border-t border-gray-200 p-3 bg-white">
            <h2 class="text-base sm:text-lg font-bold text-gray-900 mb-4">Edit Link</h2>
            <form action="/links/{{ link.id }}/update" method="post" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-900 mb-2">Title</label>
                    <input type="text" name="title" value="{{ link.title or '' }}"
                        class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all" />
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-900 mb-2">Notes</label>
                    <textarea name="notes" rows="5"
                        class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all resize-y">{{ link.notes or '' }}</textarea>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-900 mb-2">Tags</label>
                    <div class="space-y-2" data-tag-combobox>
                        <div class="flex flex-wrap gap-2 min-h-[2.25rem] rounded-lg border border-dashed border-gray-200 bg-gray-50 px-3 py-2"
                            data-selected-tags>
                            <span class="text-xs text-gray-500" data-empty-placeholder>Start typing to add tags</span>
                        </div>
                        <div class="relative">
                            <input type="text" data-tag-input autocomplete="off"
                                class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all"
                                placeholder="Start typing to search or add a tag" />
                            <div class="absolute z-40 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-48 overflow-y-auto hidden"
                                data-tag-suggestions></div>
                        </div>
                        <input type="hidden" name="tags" id="tags-input" value="{{ link.tags | map(attribute='name') | join(', ') }}" />
                        <p class="text-xs text-gray-500">Add up to 4 tags. Press Enter to create a new tag or choose from the list.</p>
                        <p class="text-xs text-red-600 hidden" data-tag-limit-warning>You can choose up to 4 tags. Remove one to add another.</p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-900 mb-2">Collection</label>
                    <div class="relative">
                        <input type="text" name="collection"
                            value="{{ link.collection.name if link.collection else '' }}"
                            class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all"
                            data-collection-input autocomplete="off" placeholder="Start typing to search or add a collection" />
                        <div class="absolute z-50 w-full mt-1 bg-white border-2 border-gray-200 rounded-lg shadow-lg max-h-48 overflow-y-auto hidden"
                            data-collection-suggestions></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Choose from existing collections or type to create a new one.</p>
                </div>
                <div class="flex gap-3 justify-end pt-2">
                    <button type="button" onclick="toggleEdit()"
                        class="px-5 py-2.5 text-gray-700 bg-white border-2 border-gray-200 rounded-lg font-medium hover:bg-gray-50 hover:border-gray-300 transition-all">Cancel</button>
                    <button type="submit"
                        class="px-6 py-2.5 bg-primary-600 text-white rounded-lg font-medium hover:bg-primary-700 transition-all shadow-md">Save Changes</button>
                </div>
            </form>
        </div>
    </article>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeDeleteModal()"></div>
        <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-6 pt-6 pb-5 sm:p-7 sm:pb-5">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-14 w-14 rounded-full bg-red-100 sm:mx-0 sm:h-12 sm:w-12">
                        <svg class="h-7 w-7 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </div>
                    <div class="mt-4 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-base sm:text-lg leading-6 font-bold text-gray-900">Delete Link</h3>
                        <div class="mt-3">
                            <p class="text-sm text-gray-600">
                                Are you sure you want to delete "<span class="font-semibold text-gray-900">{{ link.title or link.url }}</span>"? This action cannot be undone.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 sm:px-7 sm:flex sm:flex-row-reverse gap-3">
                <form action="/links/{{ link.id }}/delete" method="post" class="inline">
                    <button type="submit"
                        class="w-full inline-flex justify-center items-center gap-2 rounded-lg border border-transparent shadow-md px-5 py-2.5 bg-red-600 text-base font-medium text-white hover:bg-red-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:w-auto sm:text-sm transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Delete
                    </button>
                </form>
                <button type="button" onclick="closeDeleteModal()"
                    class="mt-3 w-full inline-flex justify-center rounded-lg border-2 border-gray-200 shadow-sm px-5 py-2.5 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 hover:border-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:w-auto sm:text-sm transition-all">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="collection-data">{{ collections | map(attribute='name') | list | tojson }}</script>
<script type="application/json" id="tag-data">{{ available_tags | default([], true) | tojson }}</script>
<script src="https://unpkg.com/lucide@latest"></script>
<script>
    const collectionDataEl = document.getElementById('collection-data');
    const tagDataEl = document.getElementById('tag-data');
    const rawCollectionOptions = collectionDataEl ? JSON.parse(collectionDataEl.textContent) : [];
    const collectionOptions = Array.isArray(rawCollectionOptions)
        ? rawCollectionOptions
            .map((item) => {
                if (!item) {
                    return null;
                }
                if (typeof item === 'string') {
                    return { name: item };
                }
                if (typeof item.name === 'string') {
                    return { id: item.id, name: item.name, slug: item.slug };
                }
                return null;
            })
            .filter((item) => item && item.name && item.name.trim().length > 0)
        : [];
    
    const rawTagOptions = tagDataEl ? JSON.parse(tagDataEl.textContent) : [];
    const tagOptions = Array.isArray(rawTagOptions)
        ? rawTagOptions
            .map((item) => {
                if (!item) {
                    return null;
                }
                if (typeof item === 'string') {
                    return { name: item };
                }
                if (typeof item.name === 'string') {
                    return { ...item, name: item.name };
                }
                return null;
            })
            .filter((item) => item && item.name && item.name.trim().length > 0)
        : [];

    const normalizeTagName = (value) => (value || '').trim().toLowerCase();
    const tagMetadata = new Map(
        tagOptions.map((tag) => [normalizeTagName(tag.name), { icon: tag.icon || null, color: tag.color || null }]),
    );

    if (collectionDataEl) {
        collectionDataEl.remove();
    }
    if (tagDataEl) {
        tagDataEl.remove();
    }
    const MAX_TAGS = 4;

    function toggleEdit() {
        const editForm = document.getElementById('edit-form');
        if (!editForm) {
            return;
        }
        editForm.classList.toggle('hidden');
    }

    function showDeleteModal() {
        const modal = document.getElementById('deleteModal');
        if (modal) {
            modal.classList.remove('hidden');
        }
    }

    function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Collection combobox
        const collectionInput = document.querySelector('[data-collection-input]');
        const collectionSuggestions = document.querySelector('[data-collection-suggestions]');

        if (collectionInput && collectionSuggestions) {
            let collectionHighlightedIndex = -1;

            const renderCollectionSuggestions = (matches) => {
                collectionSuggestions.innerHTML = '';
                if (!matches.length) {
                    collectionSuggestions.classList.add('hidden');
                    return;
                }
                matches.forEach((collection, index) => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'w-full px-4 py-2.5 text-left text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-700 transition flex items-center gap-2';
                    item.dataset.collectionSuggestion = 'true';
                    
                    // Add folder icon
                    const iconWrapper = document.createElement('span');
                    iconWrapper.className = 'flex-shrink-0 text-blue-500';
                    iconWrapper.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>';
                    item.appendChild(iconWrapper);
                    
                    const label = document.createElement('span');
                    label.className = 'flex-1';
                    label.textContent = collection.name;
                    item.appendChild(label);
                    
                    item.addEventListener('mouseenter', () => {
                        collectionHighlightedIndex = index;
                        highlightCollectionSuggestion(index);
                    });
                    item.addEventListener('click', () => {
                        collectionInput.value = collection.name;
                        collectionSuggestions.classList.add('hidden');
                        collectionInput.focus();
                    });
                    collectionSuggestions.appendChild(item);
                });
                collectionSuggestions.classList.remove('hidden');
            };

            const highlightCollectionSuggestion = (index) => {
                const items = collectionSuggestions.querySelectorAll('[data-collection-suggestion]');
                items.forEach((item, idx) => {
                    if (idx === index) {
                        item.classList.add('bg-primary-50', 'text-primary-700');
                    } else {
                        item.classList.remove('bg-primary-50', 'text-primary-700');
                    }
                });
            };

            collectionInput.addEventListener('input', (event) => {
                const query = event.target.value.trim().toLowerCase();
                if (!query) {
                    // Show all collections when input is empty but focused
                    renderCollectionSuggestions(collectionOptions.slice(0, 8));
                    return;
                }
                const matches = collectionOptions.filter((col) => col.name.toLowerCase().includes(query)).slice(0, 8);
                renderCollectionSuggestions(matches);
            });

            collectionInput.addEventListener('focus', () => {
                const query = collectionInput.value.trim().toLowerCase();
                if (!query) {
                    // Show all collections when focused with empty input
                    renderCollectionSuggestions(collectionOptions.slice(0, 8));
                } else {
                    const matches = collectionOptions.filter((col) => col.name.toLowerCase().includes(query)).slice(0, 8);
                    renderCollectionSuggestions(matches);
                }
            });

            collectionInput.addEventListener('keydown', (event) => {
                const items = collectionSuggestions.querySelectorAll('[data-collection-suggestion]');
                if (!items.length) return;

                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    collectionHighlightedIndex = (collectionHighlightedIndex + 1) % items.length;
                    highlightCollectionSuggestion(collectionHighlightedIndex);
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    collectionHighlightedIndex = collectionHighlightedIndex <= 0 ? items.length - 1 : collectionHighlightedIndex - 1;
                    highlightCollectionSuggestion(collectionHighlightedIndex);
                } else if (event.key === 'Enter' && collectionHighlightedIndex >= 0 && collectionHighlightedIndex < items.length) {
                    event.preventDefault();
                    items[collectionHighlightedIndex].click();
                } else if (event.key === 'Escape') {
                    collectionSuggestions.classList.add('hidden');
                    collectionHighlightedIndex = -1;
                }
            });

            document.addEventListener('click', (event) => {
                if (!collectionSuggestions.contains(event.target) && !collectionInput.contains(event.target)) {
                    collectionSuggestions.classList.add('hidden');
                    collectionHighlightedIndex = -1;
                }
            });
        }

        const tagsInput = document.getElementById('tags-input');
        const editForm = document.querySelector('#edit-form form');
        const comboboxRoot = document.querySelector('[data-tag-combobox]');

        if (!tagsInput || !comboboxRoot || !editForm) {
            return;
        }

    const selectedContainer = comboboxRoot.querySelector('[data-selected-tags]');
        const emptyPlaceholder = comboboxRoot.querySelector('[data-empty-placeholder]');
        const tagTextInput = comboboxRoot.querySelector('[data-tag-input]');
        const suggestionPanel = comboboxRoot.querySelector('[data-tag-suggestions]');
        const warningEl = comboboxRoot.querySelector('[data-tag-limit-warning]');

        if (!selectedContainer || !tagTextInput || !suggestionPanel) {
            return;
        }

        let selectedTags = [];
        let filteredSuggestions = [];
        let highlightedIndex = -1;

    const normalize = normalizeTagName;

        const parseTags = (value) => {
            const seen = new Set();
            const result = [];
            value.split(',').forEach((raw) => {
                const trimmed = raw.trim();
                if (!trimmed) {
                    return;
                }
                const key = normalize(trimmed);
                if (seen.has(key)) {
                    return;
                }
                seen.add(key);
                result.push(trimmed);
            });
            return result.slice(0, MAX_TAGS);
        };

        const updateHiddenInput = () => {
            tagsInput.value = selectedTags.join(', ');
        };

        const showWarning = (visible) => {
            if (!warningEl) {
                return;
            }
            warningEl.classList.toggle('hidden', !visible);
            if (tagTextInput) {
                if (visible) {
                    tagTextInput.classList.add('border-red-400', 'focus:ring-red-500', 'focus:border-red-500');
                } else {
                    tagTextInput.classList.remove('border-red-400', 'focus:ring-red-500', 'focus:border-red-500');
                }
            }
        };

        const createSuggestionIcon = (iconName, color) => {
            const iconEl = document.createElement('i');
            iconEl.dataset.lucide = iconName;
            iconEl.className = 'w-4 h-4 flex-shrink-0';
            if (color) {
                iconEl.style.color = color;
            } else {
                iconEl.classList.add('text-gray-500');
            }
            return iconEl;
        };

        const renderSelectedTags = () => {
            if (!selectedContainer) {
                return;
            }
            selectedContainer.querySelectorAll('[data-tag-pill]').forEach((pill) => pill.remove());
            selectedTags.forEach((tag) => {
                const pill = document.createElement('span');
                pill.dataset.tagPill = 'true';
                pill.className = 'inline-flex items-center gap-2 bg-white border border-gray-300 text-sm text-gray-700 px-3 py-1.5 rounded-full shadow-sm';

                const metadata = tagMetadata.get(normalize(tag));
                if (metadata && metadata.icon) {
                    const iconWrapper = document.createElement('span');
                    iconWrapper.className = 'flex items-center justify-center';
                    const iconEl = createSuggestionIcon(metadata.icon, metadata.color);
                    iconWrapper.appendChild(iconEl);
                    pill.appendChild(iconWrapper);
                }

                const label = document.createElement('span');
                label.textContent = tag;
                label.className = 'max-w-[8rem] truncate';

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'flex items-center justify-center w-5 h-5 rounded-full bg-gray-200 hover:bg-red-100 text-gray-600 hover:text-red-600 transition';
                removeBtn.innerHTML = '<svg class="w-3 h-3" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.5 3.5l7 7m0-7l-7 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                removeBtn.addEventListener('click', () => removeTag(tag));

                pill.appendChild(label);
                pill.appendChild(removeBtn);
                selectedContainer.appendChild(pill);
            });

            if (emptyPlaceholder) {
                emptyPlaceholder.classList.toggle('hidden', selectedTags.length > 0);
            }

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        const setSelectedTags = (tags) => {
            const unique = [];
            const seen = new Set();
            tags.forEach((tag) => {
                const trimmed = tag.trim();
                if (!trimmed) {
                    return;
                }
                const key = normalize(trimmed);
                if (seen.has(key)) {
                    return;
                }
                seen.add(key);
                unique.push(trimmed);
            });
            selectedTags = unique.slice(0, MAX_TAGS);
            updateHiddenInput();
            renderSelectedTags();
            updateSuggestions(tagTextInput ? tagTextInput.value : '');
            if (selectedTags.length < MAX_TAGS) {
                showWarning(false);
            }
        };

        const addTag = (tag) => {
            const trimmed = tag.trim();
            if (!trimmed) {
                return;
            }
            const key = normalize(trimmed);
            if (selectedTags.some((existing) => normalize(existing) === key)) {
                return;
            }
            if (selectedTags.length >= MAX_TAGS) {
                showWarning(true);
                return;
            }
            setSelectedTags([...selectedTags, trimmed]);
        };

        const removeTag = (tag) => {
            const key = normalize(tag);
            setSelectedTags(selectedTags.filter((existing) => normalize(existing) !== key));
        };

        const hideSuggestions = () => {
            if (!suggestionPanel) {
                return;
            }
            suggestionPanel.classList.add('hidden');
            suggestionPanel.innerHTML = '';
            filteredSuggestions = [];
            highlightedIndex = -1;
        };

        const highlightSuggestion = (index) => {
            if (!suggestionPanel) {
                return;
            }
            const items = suggestionPanel.querySelectorAll('[data-suggestion]');
            if (!items.length) {
                highlightedIndex = -1;
                return;
            }
            if (index < 0 || index >= items.length) {
                highlightedIndex = -1;
                items.forEach((item) => item.classList.remove('bg-primary-50', 'text-primary-700'));
                return;
            }
            items.forEach((item, idx) => {
                if (idx === index) {
                    item.classList.add('bg-primary-50', 'text-primary-700');
                } else {
                    item.classList.remove('bg-primary-50', 'text-primary-700');
                }
            });
            highlightedIndex = index;
        };

        const renderSuggestions = (matches) => {
            if (!suggestionPanel) {
                return;
            }
            suggestionPanel.innerHTML = '';
            filteredSuggestions = matches;
            if (!matches.length) {
                hideSuggestions();
                return;
            }

            matches.forEach((tag, index) => {
                const item = document.createElement('button');
                item.type = 'button';
                item.dataset.suggestion = 'true';
                item.className = 'w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-primary-50 transition flex items-center gap-3';

                if (tag.icon) {
                    const iconEl = createSuggestionIcon(tag.icon, tag.color);
                    item.appendChild(iconEl);
                }

                const label = document.createElement('span');
                label.className = 'flex-1 truncate';
                label.textContent = tag.name;
                item.appendChild(label);

                item.addEventListener('mouseenter', () => highlightSuggestion(index));
                item.addEventListener('mousedown', (event) => event.preventDefault());
                item.addEventListener('click', () => {
                    addTag(tag.name);
                    clearTagInput();
                    hideSuggestions();
                });
                suggestionPanel.appendChild(item);
            });

            suggestionPanel.classList.remove('hidden');
            highlightSuggestion(0);

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        const updateSuggestions = (query, showWhenEmpty = false) => {
            if (!tagTextInput) {
                return;
            }
            const normalizedQuery = query.trim().toLowerCase();
            const selectedKeys = new Set(selectedTags.map(normalize));
            const shouldHide = !normalizedQuery && !showWhenEmpty;
            if (shouldHide) {
                hideSuggestions();
                return;
            }
            const matches = tagOptions
                .filter((tag) => {
                    if (selectedKeys.has(normalize(tag.name))) {
                        return false;
                    }
                    if (!normalizedQuery) {
                        return true;
                    }
                    return tag.name.toLowerCase().includes(normalizedQuery);
                })
                .slice(0, 8);
            renderSuggestions(matches);
        };

        const clearTagInput = () => {
            if (tagTextInput) {
                tagTextInput.value = '';
            }
        };

        const moveHighlight = (delta) => {
            if (!filteredSuggestions.length) {
                return;
            }
            let newIndex = highlightedIndex;
            if (newIndex === -1) {
                newIndex = 0;
            }
            newIndex = (newIndex + delta + filteredSuggestions.length) % filteredSuggestions.length;
            highlightSuggestion(newIndex);
        };

        tagTextInput.addEventListener('focus', () => {
            updateSuggestions(tagTextInput.value, true);
        });

        tagTextInput.addEventListener('input', (event) => {
            showWarning(false);
            updateSuggestions(event.target.value, true);
        });

        tagTextInput.addEventListener('keydown', (event) => {
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    if (suggestionPanel.classList.contains('hidden')) {
                        updateSuggestions(tagTextInput.value, true);
                    }
                    moveHighlight(1);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    moveHighlight(-1);
                    break;
                case 'Enter':
                    event.preventDefault();
                    if (highlightedIndex >= 0 && filteredSuggestions[highlightedIndex]) {
                        addTag(filteredSuggestions[highlightedIndex].name);
                        clearTagInput();
                        hideSuggestions();
                    } else {
                        addTag(tagTextInput.value);
                        clearTagInput();
                        hideSuggestions();
                    }
                    break;
                case 'Tab':
                    if (!suggestionPanel.classList.contains('hidden') && highlightedIndex >= 0 && filteredSuggestions[highlightedIndex]) {
                        event.preventDefault();
                        addTag(filteredSuggestions[highlightedIndex].name);
                        clearTagInput();
                        hideSuggestions();
                    }
                    break;
                case ',':
                    event.preventDefault();
                    addTag(tagTextInput.value);
                    clearTagInput();
                    hideSuggestions();
                    break;
                case 'Backspace':
                    if (!tagTextInput.value && selectedTags.length) {
                        removeTag(selectedTags[selectedTags.length - 1]);
                        hideSuggestions();
                    }
                    break;
                case 'Escape':
                    hideSuggestions();
                    break;
                default:
                    break;
            }
        });

        document.addEventListener('click', (event) => {
            if (!comboboxRoot.contains(event.target)) {
                hideSuggestions();
            }
        });

        setSelectedTags(parseTags(tagsInput.value));
        hideSuggestions();

        editForm.addEventListener('submit', (event) => {
            if (selectedTags.length > MAX_TAGS) {
                event.preventDefault();
                showWarning(true);
                tagTextInput.focus();
                return;
            }
            updateHiddenInput();
        });
    });
</script>
{% endblock %}
