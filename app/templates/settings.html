{% extends "base.html" %}
{% block title %}Settings Â· NoteKeep{% endblock %}
{% block content %}
<div class="mb-4 sm:mb-6">
  <h1 class="text-xl sm:text-2xl font-semibold text-gray-900">Settings</h1>
</div>

{% if success_message %}
<div class="mb-4 rounded border-l-4 border-green-500 bg-green-50 px-3 sm:px-4 py-3 text-xs sm:text-sm text-green-800">{{ success_message }}</div>
{% endif %}

{% if error_message %}
<div class="mb-4 rounded border-l-4 border-red-500 bg-red-50 px-3 sm:px-4 py-3 text-xs sm:text-sm text-red-800">{{ error_message }}</div>
{% endif %}

<!-- Tabs -->
<div class="border-b border-gray-200 mb-4 sm:mb-6">
  <nav class="flex gap-4 sm:gap-8">
    <button 
      onclick="switchTab('tags')" 
      data-tab="tags" 
      class="tab-button py-2 sm:py-3 px-1 border-b-2 border-indigo-600 text-indigo-600 font-medium text-xs sm:text-sm"
    >
      Tags
    </button>
    <button 
      onclick="switchTab('collections')" 
      data-tab="collections" 
      class="tab-button py-2 sm:py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-xs sm:text-sm"
    >
      Collections
    </button>
  </nav>
</div>

<!-- Tags Tab -->
<div id="tags-tab" class="tab-content">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
    <!-- Add New Tag -->
    <div class="bg-white border border-gray-200 rounded p-3 sm:p-4">
      <h2 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">Add New Tag</h2>
      <form action="/settings/tags/create" method="post" class="space-y-3">
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-900 mb-1.5">Tag Name</label>
          <input 
            type="text" 
            name="name" 
            required 
            placeholder="e.g., python, design, tutorial"
            class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" 
          />
        </div>
        <button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white rounded font-medium text-sm hover:bg-indigo-700 transition">Add Tag</button>
      </form>
    </div>

    <!-- Existing Tags -->
    <div class="bg-white border border-gray-200 rounded p-3 sm:p-4">
      <h2 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">Existing Tags ({{ tags|length }})</h2>
      <div class="space-y-2 max-h-96 overflow-y-auto">
        {% if not tags %}
        <p class="text-xs sm:text-sm text-gray-500">No tags yet. Add your first tag to get started.</p>
        {% else %}
        {% for tag in tags %}
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded hover:bg-gray-100 transition">
          <div class="flex items-center gap-2 flex-1 min-w-0">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700 border border-gray-200">/{{ tag.name }}</span>
            <span class="text-xs text-gray-400">({{ tag.link_count }})</span>
          </div>
          <div class="flex items-center gap-2">
            <button 
              onclick="editTag({{ tag.id }}, '{{ tag.name }}')" 
              class="text-indigo-600 hover:text-indigo-700 text-xs sm:text-sm font-medium"
              title="Edit"
            >
              Edit
            </button>
            <button 
              onclick="showDeleteTagModal({{ tag.id }}, '{{ tag.name | replace("'", "\\'") }}', {{ tag.link_count }})" 
              class="text-red-600 hover:text-red-700 text-xs sm:text-sm font-medium" 
              title="Delete"
            >
              Delete
            </button>
          </div>
        </div>
        {% endfor %}
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Collections Tab -->
<div id="collections-tab" class="tab-content hidden">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
    <!-- Add New Collection -->
    <div class="bg-white border border-gray-200 rounded p-3 sm:p-4">
      <h2 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">Add New Collection</h2>
      <form action="/settings/collections/create" method="post" class="space-y-3">
        <div>
          <label class="block text-xs sm:text-sm font-medium text-gray-900 mb-1.5">Collection Name</label>
          <input 
            type="text" 
            name="name" 
            required 
            placeholder="e.g., Work, Personal, Research"
            class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" 
          />
        </div>
        <button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white rounded font-medium text-sm hover:bg-indigo-700 transition">Add Collection</button>
      </form>
    </div>

    <!-- Existing Collections -->
    <div class="bg-white border border-gray-200 rounded p-3 sm:p-4">
      <h2 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">Existing Collections ({{ collections|length }})</h2>
      <div class="space-y-2 max-h-96 overflow-y-auto">
        {% if not collections %}
        <p class="text-xs sm:text-sm text-gray-500">No collections yet. Add your first collection to organize your links.</p>
        {% else %}
        {% for collection in collections %}
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded hover:bg-gray-100 transition">
          <div class="flex items-center gap-2 flex-1 min-w-0">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200">{{ collection.name }}</span>
            <span class="text-xs text-gray-400">({{ collection.link_count }})</span>
          </div>
          <div class="flex items-center gap-2">
            <button 
              onclick="editCollection({{ collection.id }}, '{{ collection.name }}')" 
              class="text-indigo-600 hover:text-indigo-700 text-xs sm:text-sm font-medium"
              title="Edit"
            >
              Edit
            </button>
            <button 
              onclick="showDeleteCollectionModal({{ collection.id }}, '{{ collection.name | replace("'", "\\'") }}', {{ collection.link_count }})" 
              class="text-red-600 hover:text-red-700 text-xs sm:text-sm font-medium" 
              title="Delete"
            >
              Delete
            </button>
          </div>
        </div>
        {% endfor %}
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeModal(event)">
  <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md" onclick="event.stopPropagation()">
    <h2 class="text-xl font-semibold text-gray-900 mb-4" id="modal-title">Edit</h2>
    <form id="edit-form" method="post" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-900 mb-1.5">Name</label>
        <input 
          type="text" 
          name="name" 
          id="edit-name-input"
          required 
          class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" 
        />
      </div>
      <div class="flex gap-2 justify-end">
        <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700 border border-gray-300 rounded text-sm hover:bg-gray-100 transition">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded font-medium text-sm hover:bg-indigo-700 transition">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script>
function switchTab(tabName) {
  // Update tab buttons
  document.querySelectorAll('.tab-button').forEach(btn => {
    if (btn.dataset.tab === tabName) {
      btn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
      btn.classList.add('border-indigo-600', 'text-indigo-600');
    } else {
      btn.classList.remove('border-indigo-600', 'text-indigo-600');
      btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');
    }
  });
  
  // Update tab content
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.add('hidden');
  });
  document.getElementById(tabName + '-tab').classList.remove('hidden');
}

function editTag(id, name) {
  document.getElementById('modal-title').textContent = 'Edit Tag';
  document.getElementById('edit-name-input').value = name;
  document.getElementById('edit-form').action = '/settings/tags/' + id + '/update';
  document.getElementById('edit-modal').classList.remove('hidden');
  document.getElementById('edit-name-input').focus();
}

function editCollection(id, name) {
  document.getElementById('modal-title').textContent = 'Edit Collection';
  document.getElementById('edit-name-input').value = name;
  document.getElementById('edit-form').action = '/settings/collections/' + id + '/update';
  document.getElementById('edit-modal').classList.remove('hidden');
  document.getElementById('edit-name-input').focus();
}

function closeModal(event) {
  if (!event || event.target.id === 'edit-modal') {
    document.getElementById('edit-modal').classList.add('hidden');
  }
}

function showDeleteTagModal(tagId, tagName, linkCount) {
  const modal = document.getElementById('deleteTagModal');
  const nameElement = document.getElementById('deleteTagName');
  const countElement = document.getElementById('deleteTagCount');
  const form = document.getElementById('deleteTagForm');
  
  nameElement.textContent = tagName;
  countElement.textContent = linkCount;
  form.action = `/settings/tags/${tagId}/delete`;
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeDeleteTagModal() {
  const modal = document.getElementById('deleteTagModal');
  modal.classList.add('hidden');
  document.body.style.overflow = '';
}

function showDeleteCollectionModal(collectionId, collectionName, linkCount) {
  const modal = document.getElementById('deleteCollectionModal');
  const nameElement = document.getElementById('deleteCollectionName');
  const countElement = document.getElementById('deleteCollectionCount');
  const form = document.getElementById('deleteCollectionForm');
  
  nameElement.textContent = collectionName;
  countElement.textContent = linkCount;
  form.action = `/settings/collections/${collectionId}/delete`;
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeDeleteCollectionModal() {
  const modal = document.getElementById('deleteCollectionModal');
  modal.classList.add('hidden');
  document.body.style.overflow = '';
}

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeModal();
    closeDeleteTagModal();
    closeDeleteCollectionModal();
  }
});

// Check URL hash for active tab
window.addEventListener('DOMContentLoaded', () => {
  const hash = window.location.hash.substring(1);
  if (hash === 'collections') {
    switchTab('collections');
  }
});
</script>

<!-- Delete Tag Modal -->
<div id="deleteTagModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeDeleteTagModal()"></div>
    
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="sm:flex sm:items-start">
          <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
            <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Delete Tag</h3>
            <div class="mt-2">
              <p class="text-sm text-gray-500">
                Are you sure you want to delete the tag "<span id="deleteTagName" class="font-medium text-gray-900"></span>"?
              </p>
              <p class="text-sm text-gray-500 mt-2">
                This will remove this tag from <span id="deleteTagCount" class="font-medium text-gray-900"></span> link(s), but the links themselves will not be deleted.
              </p>
              <p class="text-sm text-red-600 mt-2 font-medium">This action cannot be undone.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <form id="deleteTagForm" method="post" class="inline">
          <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
            Delete Tag
          </button>
        </form>
        <button type="button" onclick="closeDeleteTagModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Collection Modal -->
<div id="deleteCollectionModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeDeleteCollectionModal()"></div>
    
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="sm:flex sm:items-start">
          <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
            <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Delete Collection</h3>
            <div class="mt-2">
              <p class="text-sm text-gray-500">
                Are you sure you want to delete the collection "<span id="deleteCollectionName" class="font-medium text-gray-900"></span>"?
              </p>
              <p class="text-sm text-gray-500 mt-2">
                This will remove this collection from <span id="deleteCollectionCount" class="font-medium text-gray-900"></span> link(s), but the links themselves will not be deleted.
              </p>
              <p class="text-sm text-red-600 mt-2 font-medium">This action cannot be undone.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <form id="deleteCollectionForm" method="post" class="inline">
          <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
            Delete Collection
          </button>
        </form>
        <button type="button" onclick="closeDeleteCollectionModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
